<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
</head>
<body>
    {% for country in countries %}
        <input type="checkbox" id="{{ country.code }}" name="selected_countries" value="{{ country.code }}">
        <label for="{{ country.code }}">{{ country.name }}</label><br>
    {% endfor %}
<canvas class="my-4 w-100" id="myChart" width="1540" height="650"></canvas>
<script>
        const countrySelect = document.getElementById('countrySelect');
        const chartData = JSON.parse('{{ data|escapejs }}');

        const getSelectedCountries = () => {
            const selectedOptions = [...countrySelect.selectedOptions];
            return selectedOptions.map(option => option.value);
        };

        const filterDataByCountries = (data, countries) => {
            return data.filter(item => countries.includes(item.code));
        };

        const createChart = (filteredData) => {
            const labels = [...new Set(filteredData.map(item => item.date))];
            const datasets = [];
            const groupedData = filteredData.reduce((acc, item) => {
                if (!acc[item.code]) acc[item.code] = [];
                acc[item.code].push(item.rate);
                return acc;
            }, {});

            for (const [code, rates] of Object.entries(groupedData)) {
                datasets.push({
                    label: code,
                    data: rates,
                    borderColor: '#' + Math.floor(Math.random() * 16777215).toString(16),
                    fill: false
                });
            }

            const ctx = document.getElementById('myChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day'
                            }
                        }
                    }
                }
            });
        };

        countrySelect.addEventListener('change', () => {
            const selectedCountries = getSelectedCountries();
            const filteredData = filterDataByCountries(chartData.currency_rates, selectedCountries);
            createChart(filteredData);
        });

        // Initial load
        const initialCountries = getSelectedCountries();
        const initialFilteredData = filterDataByCountries(chartData.currency_rates, initialCountries);
        createChart(initialFilteredData);
    </script>

</body>
</html>